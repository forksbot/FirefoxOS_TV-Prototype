{"version":3,"sources":["../../app/scripts/filter_manager.js"],"names":[],"mappings":"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","file":"filter_manager.js","sourcesContent":["/* global CardFilter */\n\n(function(exports) {\n  'use strict';\n\n  /**\n   * FilterManager is the controller class of filter. It relies on\n   * {@link CardFilter} to do UI works of filter itself. However it also needs\n   * to co-operate with {@link http://bit.ly/1JcrKZO|SmartBubbles},\n   * {@link Edit}, and {@link Home} classes to do the actual *filtering* task\n   * in smart-home.\n   *\n   * The working flow when user change filter is like:\n   *\n   * 1. FilterManager receives `filterchanged` from {@link CardFilter}\n   * 2. Play bubbling down animation, see\n   *    {@link FilterManager#onFilterChanged|onFilterChanged()}.\n   * 3. When animation ends, change card icon in smart-home, with help from\n   *    {@link Home} and XScrollable. See\n   *    {@link FilterManager#onAnimationEnd|onAnimationEnd()}.\n   * 4. Play bubbling up animation, see\n   *    {@link FilterManager#_performBubbleUp|_performBubbleUp()}.\n   *\n   * @class FilterManager\n   * @requires {@link Home}\n   * @requires XScrollable\n   * @requires {@link Edit}\n   * @requires {@link CardFilter}\n   * @requires {@link http://bit.ly/1JcrKZO|SmartBubbles}\n   */\n  var FilterManager = function() {};\n\n  /**\n   * @namespace FilterManager.FILTERS\n   */\n  FilterManager.FILTERS = Object.freeze({\n    /**\n     * @readonly\n     * @memberof FilterManager.FILTERS\n     * @property {String} name - value is `all`\n     * @property {String} iconName - value is `filter`\n     */\n    'ALL': {\n      name: 'all',\n      iconName: 'filter'\n    },\n    /**\n     * @readonly\n     * @memberof FilterManager.FILTERS\n     * @property {String} name - value is `tv`\n     * @property {String} iconName - value is `tv`\n     */\n    'TV': {\n      name: 'tv',\n      iconName: 'tv'\n    },\n    /**\n     * @readonly\n     * @memberof FilterManager.FILTERS\n     * @property {String} name - value is `device`\n     * @property {String} iconName - value is `device`\n     */\n    'DEVICE': {\n      name: 'device',\n      iconName: 'device'\n    },\n    /**\n     * @readonly\n     * @memberof FilterManager.FILTERS\n     * @property {String} name - value is `application`\n     * @property {String} iconName - value is `application`\n     */\n    'APPLICATION': {\n      name: 'application',\n      iconName: 'application'\n    },\n    /**\n     * @readonly\n     * @memberof FilterManager.FILTERS\n     * @property {String} name - value is `website`\n     * @property {String} iconName - value is `website`\n     */\n    'WEBSITE': {\n      name: 'website',\n      iconName: 'web'\n    }\n  });\n\n  FilterManager.prototype = {\n    /**\n     * Initialize FilterManager\n     *\n     * @public\n     * @method  FilterManager#init\n     * @param  {Object} options\n     * @param  {Object} options.cardListElem - `HTMLElement` of `card-list`\n     * @param  {Object} options.cardScrollable - instance of XScrollable\n     * @param  {Object} options.home - instance of {@link Home}\n     * @param  {Object} options.cardManager - instance of CardManager\n     */\n    init: function(options) {\n      this._cardListElem = options.cardListElem;\n      this._cardScrollable = options.cardScrollable;\n      this._home = options.home;\n      this._edit = this._home.edit;\n      this._cardManager = options.cardManager;\n\n      this._cardFilter = new CardFilter();\n      this._cardFilter.start(document.getElementById('filter-tab-group'));\n      this._cardFilter.filter = FilterManager.FILTERS.ALL.iconName;\n      this._filterChangedHandler = this.onFilterChanged.bind(this);\n      this._cardFilter.on('filterchanged', this._filterChangedHandler);\n      this._cardFilter.on('opened', function() {\n        this._home.cleanFolderScrollable(true);\n      }.bind(this));\n\n      this._hideFilter = this.hide.bind(this);\n      this._showFilter = this.show.bind(this);\n      this._edit.on('enter-edit-mode', this._hideFilter);\n      this._edit.on('exit-edit-mode', this._showFilter);\n\n      this._smartBubblesElem = document.getElementById('bubbles');\n\n      this._animationEndHandler = this.onAnimationEnd.bind(this);\n      this._smartBubblesElem.addEventListener('all-items-bubbled',\n        this._animationEndHandler);\n    },\n\n    /**\n     * Do the opposite of initalization\n     *\n     * @public\n     * @method  FilterManager#uninit\n     */\n    uninit: function() {\n      this._cardFilter.off('filterchanged', this._filterChangedHandler);\n      this._edit.off('enter-edit-mode', this._hideFilter);\n      this._edit.off('exit-edit-mode', this._showFilter);\n      this._smartBubblesElem.removeEventListener('all-items-bubbled',\n        this._animationEndHandler);\n    },\n\n    _filteredCardList: undefined,\n\n    _isFirstFrame: false,\n\n    _isFilterChanging: false,\n\n    _isBubbleSinking: function fm_isBubbleSinking() {\n      return (\n        this._cardListElem.getAttribute('smart-bubbles-direction') === 'down');\n    },\n\n    /**\n     * Perform bubbling up animation. We must hide the first frame of animation\n     * because there are sliding animation on XScrollable. We don't want user to\n     * see this according to UX spec.\n     *\n     * @private\n     * @method  FilterManager#_performBubbleUp\n     */\n    _performBubbleUp: function fm_performBubbleUp() {\n      if (this._isFirstFrame) {\n        this._isFirstFrame = false;\n        this._cardListElem.style.transition = 'none';\n        this._cardScrollable.resetScroll();\n        window.requestAnimationFrame(this._performBubbleUp.bind(this));\n      } else {\n        this._cardListElem.style.opacity = 1;\n        this._cardListElem.style.transition = undefined;\n        this._cardListElem.removeAttribute('smart-bubbles-direction');\n        this._smartBubblesElem.play(\n          document.querySelectorAll('#card-list > .card > .app-button'));\n      }\n    },\n\n    /**\n     * Get constant object of {@link FilterManager.FILTERS} of the `iconName`\n     *\n     * @public\n     * @method  FilterManager#getFilterByIconName\n     * @param  {String} iconName -\n     */\n    getFilterByIconName: function fm_getFilterByIconName(iconName) {\n      var keys = Object.keys(FilterManager.FILTERS);\n      var filter;\n      keys.some(function(key) {\n        var cursor = FilterManager.FILTERS[key];\n        if (iconName === cursor.iconName) {\n          filter = cursor;\n          return true;\n        }\n      });\n      return filter;\n    },\n\n    /**\n     * EventHandler of `all-items-bubbled` event.\n     * [SmartBubbles](http://bit.ly/1JcrKZO) fires `all-items-bubbled` when it\n     * is done with bubbling down animation. We start to alter the card content\n     * of XScrollable only after bubbling down animation ends. And after we are\n     * done with altering content, we'll have to perform bubbling up animation\n     * by calling {@link FilterManager#_performBubbleUp}.\n     *\n     * @public\n     * @method FilterManager#onAnimationEnd\n     */\n    onAnimationEnd: function fm_onAnimationEnd() {\n      if (!this._isFilterChanging) {\n        return;\n      }\n\n      var that = this;\n      var filter = this.getFilterByIconName(this._cardFilter.filter);\n      var gotFilteredCardList = function(filteredList) {\n        filteredList.forEach(function(card) {\n          that._cardScrollable.addNode(that._home.createCardNode(card));\n        });\n        that._filteredCardList =\n          (filter.name !== 'all') ? filteredList : undefined;\n        that._cardListElem.style.opacity = 0;\n        window.requestAnimationFrame(that._performBubbleUp.bind(that));\n      };\n\n      if (this._isBubbleSinking()) {\n        this._cardScrollable.clean();\n        this._cardManager.getFilteredCardList(filter.name).then(\n          gotFilteredCardList);\n      } else {\n        this._isFilterChanging = false;\n      }\n    },\n\n    /**\n     * EventHandler of `filterchanged` event. {@link CardFilter} fires\n     * `filterchanged` event whenever user select a different filter. This is\n     * becasue we need to play bubbling down animation whenever filter is\n     * changed.\n     *\n     * @public\n     * @method  FilterManager#onFilterChanged\n     */\n    onFilterChanged: function fm_onFilterChange(iconName) {\n      this._isFirstFrame = true;\n\n      if (this._isFilterChanging) {\n        this._smartBubblesElem.stopImmediately();\n      }\n      this._isFilterChanging = true;\n      this._cardListElem.setAttribute('smart-bubbles-direction', 'down');\n\n      // Notice that methods like document.querySelectorAll or\n      // document.getElementsByClassName returns elements based on the\n      // sequence of time that element added to DOM structure. But we should\n      // play animation in the left-to-right order. Card scrollable keeps the\n      // order of all items, we just use them directly to play animation.\n      // See http://bugzil.la/1169538\n      this._smartBubblesElem.play(this._cardScrollable.allItems);\n    },\n\n    /**\n     * Hide filter. This should be called when we are in edit mode.\n     *\n     * @public\n     * @method  FilterManager#hide\n     */\n    hide: function fm_hide() {\n      this._cardFilter.hide();\n    },\n\n    /**\n     * Hide filter. This should be called when we are exit from edit mode.\n     *\n     * @public\n     * @method  FilterManager#show\n     */\n    show: function fm_show() {\n      this._cardFilter.show();\n    },\n\n    /**\n     * Reset filter to {@link FilterManager.FILTERS.ALL}. We should always reset\n     * filter when smart-home is back to foreground.\n     *\n     * @public\n     * @method  FilterManager#resetFilter\n     */\n    resetFilter: function fm_resetFilter() {\n      if (this._cardFilter.filter !== FilterManager.FILTERS.ALL.iconName) {\n        this._cardFilter.filter = FilterManager.FILTERS.ALL.iconName;\n      }\n    }\n  };\n\n  exports.FilterManager = FilterManager;\n}(window));\n"]}